<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Å—Ç–∞–º–∏ ‚Äî –ë–∏–∑–Ω–µ—Å-–∫–ª–∞—Å—Å</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="index.css">
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–µ—Å–ª–∞–º–∏ –∏ –∑–∞–∫–∞–∑–∞–º–∏ –±–∏–∑–Ω–µ—Å –∫–ª–∞—Å—Å–∞</h1>
    <div class="buttons-settings">
        <button class="settings-button btn" id="settings-button" onclick="openSettingsModal()">‚öôÔ∏è</button>
        <button class="theme-toggle btn" id="theme-toggle" onclick="toggleTheme()">üåô</button>
    </div>
    <div class="main-container">
        <div class="left-column" id="left-column"></div>
        <div class="right-column" id="right-column"></div>
    </div>

    <div class="buttons">
        <button class="add-button btn" id="add-button" onclick="addSeat()">–î–æ–±–∞–≤–∏—Ç—å –∫—Ä–µ—Å–ª–æ/–∑–∞–∫–∞–∑</button>
        <button class="next-button btn" id="next-button" onclick="nextStep()">–ü—Ä–∏–Ω—è—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑</button>
        <button class="reset-button btn" id="reset-button" onclick="resetAll()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        <button class="load-menu-button btn" onclick="openFlightModal()">–ü–æ–¥–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é</button>
        <button class="view-all-orders-button btn" onclick="viewAllOrders()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã</button>
    </div>

    <!-- –û–≤–µ—Ä–ª–µ–π –∏ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="modal-overlay" id="seat-input-modal-overlay" style="display: none;">
        <div class="seat-input-modal modal" id="seat-input-modal" style="display: none;">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –∫—Ä–µ—Å–ª–∞</h3>
            <div class="seats-grid" id="seats-grid"></div>
            <div class="modal-footer">
                <button class="modal-button btn close-button" onclick="closeSeatInputModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-button btn" onclick="confirmAddSelectedSeats()">–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="orders-modal-overlay" style="display: none;">
        <div class="orders-modal modal" id="orders-modal" style="min-width: 65%; display: none;">
            <h3>–í—Å–µ –∑–∞–∫–∞–∑—ã</h3>
            <ul id="all-orders-list"></ul>
            <button class="modal-button btn" onclick="shareOrders('telegram')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Telegram</button>
            <button class="modal-button btn" onclick="shareOrders('whatsapp')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ WhatsApp</button>
            <button class="modal-button btn close-button" onclick="closeOrdersModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal-overlay" style="display: none;">
        <div class="settings-modal modal" id="settings-modal" style="display: none;">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –º–µ—Å—Ç</h3>
            
            <div class="setting-group">
                <label for="seat-letters">–ë—É–∫–≤—ã –º–µ—Å—Ç:</label>
                <input type="text" id="seat-letters" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: A,C,D,F"
                       pattern="[A-Z,]+"
                       title="–¢–æ–ª—å–∫–æ –∑–∞–≥–ª–∞–≤–Ω—ã–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
                <div class="setting-description">
                    –£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–ª–∞–≤–Ω—ã–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.
                    –ù–∞–ø—Ä–∏–º–µ—Ä: A,C,D,F (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)
                </div>
            </div>
            
            <div class="setting-group">
                <label for="start-row">–ù–∞—á–∞–ª—å–Ω—ã–π —Ä—è–¥:</label>
                <input type="number" id="start-row" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1"
                       min="1" max="100">
                <div class="setting-description">
                    –ù–æ–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ —Ä—è–¥–∞ –≤ —Å–∞–ª–æ–Ω–µ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)
                </div>
            </div>
            
            <div class="setting-group">
                <label for="end-seat">–ö–æ–Ω–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ:</label>
                <input type="text" id="end-seat" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 4F"
                       pattern="[0-9]+[A-Z]?"
                       title="–§–æ—Ä–º–∞—Ç: –Ω–æ–º–µ—Ä —Ä—è–¥–∞ –∏ –±—É–∫–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 4F)">
                <div class="setting-description">
                    –ü–æ—Å–ª–µ–¥–Ω–µ–µ –º–µ—Å—Ç–æ –≤ —Å–∞–ª–æ–Ω–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 4F - 4 —Ä—è–¥, –º–µ—Å—Ç–æ F)
                </div>
            </div>
            
            <div class="setting-group checkbox-group">
                <label>
                    <input type="checkbox" id="use-letters" checked> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±—É–∫–≤—ã
                </label>
                <div class="setting-description">
                    –ï—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ - –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä–∞ —Ä—è–¥–æ–≤
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="modal-button btn" onclick="applySettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="modal-button btn close-button" onclick="closeSettingsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="flight-modal-overlay" style="display: none;">
        <div class="flight-modal modal" id="flight-modal" style="display: none;">
            <h3>–ü–æ–¥–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é</h3>
            <select id="flight-direction">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</option>
            </select>
            <button class="modal-button btn" onclick="loadMenuFromGitHub()">–ü–æ–¥–≥—Ä—É–∑–∏—Ç—å</button>
            <button class="modal-button btn close-button" onclick="closeFlightModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const leftColumn = document.getElementById('left-column');
        const rightColumn = document.getElementById('right-column');
        const ordersModal = document.getElementById('orders-modal');
        const allOrdersList = document.getElementById('all-orders-list');
        const settingsModal = document.getElementById('settings-modal');
        const flightModal = document.getElementById('flight-modal');
        const seatLettersInput = document.getElementById('seat-letters');
        const startRowInput = document.getElementById('start-row');
        const endSeatInput = document.getElementById('end-seat');
        const useLettersCheckbox = document.getElementById('use-letters');
        const flightDirectionSelect = document.getElementById('flight-direction');
        const themeToggle = document.getElementById('theme-toggle');
        const seatInputModal = document.getElementById('seat-input-modal');
        const seatsGrid = document.getElementById('seats-grid');
    
        let selectedSeats = JSON.parse(localStorage.getItem('selectedSeats')) || [];
        let seatLetters = ['F', 'D', 'C', 'A'];
        let startRow = 1;
        let endSeat = '3';
        let useLetters = true;
    
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light-theme');
            themeToggle.textContent = '‚òÄÔ∏è';
        } else {
            themeToggle.textContent = 'üåô';
        }
    
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            themeToggle.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }
    
        function openModal(modalId) {
            const overlay = document.getElementById(`${modalId}-overlay`);
            const modal = document.getElementById(modalId);
            overlay.style.display = 'block';
            modal.style.display = 'block';
            
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    closeModal(modalId);
                }
            };
        }
        
        function closeModal(modalId) {
            const overlay = document.getElementById(`${modalId}-overlay`);
            const modal = document.getElementById(modalId);
            overlay.style.display = 'none';
            modal.style.display = 'none';
        }
    
        function loadSeats() {
            let savedSeats = JSON.parse(localStorage.getItem('savedSeats')) || [];
            savedSeats = savedSeats.map(seat => {
                const match = seat.match(/^(\d+)([a-zA-Z]?)$/);
                if (!match) return seat;
                return match[1] + (match[2] ? match[2].toUpperCase() : '');
            });
            
            localStorage.setItem('savedSeats', JSON.stringify(savedSeats));
            selectedSeats = JSON.parse(localStorage.getItem('selectedSeats')) || [];
            leftColumn.innerHTML = '';
            rightColumn.innerHTML = '';

            savedSeats.sort((a, b) => {
                const getRow = s => parseInt(s.match(/\d+/)[0]);
                const getLetter = s => s.match(/[A-Z]/)?.[0] || '';
                
                const rowA = getRow(a);
                const rowB = getRow(b);
                
                if (rowA !== rowB) return rowA - rowB;
                
                const letterA = getLetter(a);
                const letterB = getLetter(b);
                const indexA = seatLetters.indexOf(letterA);
                const indexB = seatLetters.indexOf(letterB);
                
                return indexA - indexB;
            });

            savedSeats.forEach(seat => {
                const savedMenu = JSON.parse(localStorage.getItem(`menu_${seat}`)) || {};
                const hasOrder = Object.keys(savedMenu).some(key => key !== 'passengerName' && savedMenu[key]?.checked);
                const passengerName = savedMenu.passengerName ? ` (${savedMenu.passengerName})` : '';
                
                const seatElement = document.createElement('div');
                seatElement.setAttribute('data-seat', seat);
                seatElement.textContent = seat + (hasOrder ? ' (–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ)' : '') + passengerName;

                if (selectedSeats.includes(seat)) {
                    seatElement.className = 'seat selected-seat';
                    rightColumn.appendChild(seatElement);
                } else {
                    seatElement.className = 'seat' + (hasOrder ? ' saved-seat' : '');
                    
                    const allSeats = Array.from(leftColumn.querySelectorAll('.seat'));
                    let insertBefore = null;
                    
                    for (let i = 0; i < allSeats.length; i++) {
                        const currentSeat = allSeats[i].getAttribute('data-seat');
                        if (compareSeats(seat, currentSeat) < 0) {
                            insertBefore = allSeats[i];
                            break;
                        }
                    }
                    
                    if (insertBefore) {
                        leftColumn.insertBefore(seatElement, insertBefore);
                    } else {
                        leftColumn.appendChild(seatElement);
                    }
                }
            });
        }
    
        function viewAllOrders() {
            const savedSeats = JSON.parse(localStorage.getItem('savedSeats')) || [];
            allOrdersList.innerHTML = '';

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ savedSeats –ø–æ –Ω–æ–º–µ—Ä—É —Ä—è–¥–∞ –∏ –±—É–∫–≤–µ –º–µ—Å—Ç–∞
            savedSeats.sort((a, b) => {
                const getRow = s => parseInt(s.match(/\d+/)[0]);
                const getLetter = s => s.match(/[A-Z]/)?.[0] || '';
                
                const rowA = getRow(a);
                const rowB = getRow(b);
                
                if (rowA !== rowB) return rowA - rowB;
                
                const letterA = getLetter(a);
                const letterB = getLetter(b);
                const indexA = seatLetters.indexOf(letterA);
                const indexB = seatLetters.indexOf(letterB);
                
                return indexA - indexB;
            });

            savedSeats.forEach(seat => {
                const savedMenu = JSON.parse(localStorage.getItem(`menu_${seat}`)) || {};
                const passengerName = savedMenu.passengerName ? ` (${savedMenu.passengerName})` : '';
                let hasItems = false;
                let sections = {};

                Object.entries(savedMenu).forEach(([item, data]) => {
                    if (item !== 'passengerName' && (data.checked || (data.subitems && data.subitems.length > 0))) {
                        hasItems = true;
                        const section = data.section || '–ë–µ–∑ —Ä–∞–∑–¥–µ–ª–∞';
                        
                        if (!sections[section]) sections[section] = [];
                        
                        if (data.checked) {
                            sections[section].push(item);
                        }
                        
                        if (data.subitems && data.subitems.length > 0) {
                            data.subitems.forEach(subitem => {
                                sections[section].push(`  - ${subitem}`);
                            });
                        }
                    }
                });

                if (hasItems) {
                    const listItem = document.createElement('li');
                    let orderDetails = `<strong>–ú–µ—Å—Ç–æ ${seat}${passengerName}:</strong><br>`;
                    
                    Object.keys(sections).forEach(section => {
                        orderDetails += `<strong>${section}:</strong><br>${sections[section].join('<br>')}<br>`;
                    });
                    
                    listItem.innerHTML = orderDetails;
                    allOrdersList.appendChild(listItem);
                }
            });

            openModal('orders-modal');
        }
    
        function closeOrdersModal() {
            closeModal('orders-modal');
        }
    
        function shareOrders(platform) {
            const savedSeats = JSON.parse(localStorage.getItem('savedSeats')) || [];
            let ordersText = '–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤:\n\n';
    
            savedSeats.forEach(seat => {
                const savedMenu = JSON.parse(localStorage.getItem(`menu_${seat}`)) || {};
                let hasItems = false;
                let sections = {};
                const passengerName = savedMenu.passengerName ? ` (${savedMenu.passengerName})` : '';
    
                Object.keys(savedMenu).forEach(item => {
                    if (item !== 'passengerName' && savedMenu[item]?.checked) {
                        hasItems = true;
                        const section = savedMenu[item].section || '–ë–µ–∑ —Ä–∞–∑–¥–µ–ª–∞';
                        if (!sections[section]) sections[section] = [];
                        sections[section].push(item);
                        if (savedMenu[item].subitems && savedMenu[item].subitems.length > 0) {
                            savedMenu[item].subitems.forEach(subitem => {
                                sections[section].push(`  - ${subitem}`);
                            });
                        }
                    }
                });
    
                if (hasItems) {
                    ordersText += `–ú–µ—Å—Ç–æ ${seat}${passengerName}:\n`;
                    Object.keys(sections).forEach(section => {
                        ordersText += `${section}:\n${sections[section].join('\n')}\n`;
                    });
                    ordersText += '\n';
                }
            });
    
            const encodedText = encodeURIComponent(ordersText);
            if (platform === 'telegram') {
                window.open(`https://t.me/share/url?url=${encodeURIComponent('–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤')}&text=${encodedText}`, '_blank');
            } else if (platform === 'whatsapp') {
                window.open(`https://api.whatsapp.com/send?text=${encodedText}`, '_blank');
            }
        }
    
        function handleSeatClick(event) {
            const seat = event.target;
            const seatNumber = seat.getAttribute('data-seat');

            if (seat.parentElement === leftColumn) {
                const selectedSeat = document.createElement('div');
                selectedSeat.className = 'seat selected-seat';
                selectedSeat.setAttribute('data-seat', seatNumber);
                
                const savedMenu = JSON.parse(localStorage.getItem(`menu_${seatNumber}`)) || {};
                const passengerName = savedMenu.passengerName ? ` (${savedMenu.passengerName})` : '';
                selectedSeat.textContent = seatNumber + passengerName;
                
                rightColumn.appendChild(selectedSeat);
                seat.remove();
                selectedSeats.push(seatNumber);
            } else if (seat.parentElement === rightColumn) {
                const savedSeats = JSON.parse(localStorage.getItem('savedSeats')) || [];
                const savedMenu = JSON.parse(localStorage.getItem(`menu_${seatNumber}`)) || {};
                const hasOrder = Object.keys(savedMenu).some(key => key !== 'passengerName' && savedMenu[key]?.checked);
                
                const originalSeat = document.createElement('div');
                originalSeat.className = 'seat' + (hasOrder ? ' saved-seat' : '');
                originalSeat.setAttribute('data-seat', seatNumber);
                
                const passengerName = savedMenu.passengerName ? ` (${savedMenu.passengerName})` : '';
                originalSeat.textContent = seatNumber + (hasOrder ? ' (–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ)' : '') + passengerName;
                
                const allSeats = Array.from(leftColumn.querySelectorAll('.seat'));
                let insertBefore = null;
                
                for (let i = 0; i < allSeats.length; i++) {
                    if (compareSeats(seatNumber, allSeats[i].getAttribute('data-seat')) < 0) {
                        insertBefore = allSeats[i];
                        break;
                    }
                }
                
                if (insertBefore) {
                    leftColumn.insertBefore(originalSeat, insertBefore);
                } else {
                    leftColumn.appendChild(originalSeat);
                }
                
                seat.remove();
                selectedSeats = selectedSeats.filter(s => s !== seatNumber);
            }

            localStorage.setItem('selectedSeats', JSON.stringify(selectedSeats));
        }
    
        function nextStep() {
            if (selectedSeats.length === 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –º–µ—Å—Ç–æ!');
                return;
            }
            localStorage.setItem('currentSeats', JSON.stringify(selectedSeats));
            window.location.href = 'menu.html';
        }
    
        function resetAll() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                const savedSeats = JSON.parse(localStorage.getItem('savedSeats')) || [];
                savedSeats.forEach(seat => {
                    localStorage.removeItem(`menu_${seat}`);
                });
                localStorage.removeItem('savedSeats');
                localStorage.removeItem('selectedSeats');
                selectedSeats = [];
                window.location.reload();
            }
        }
    
        function compareSeats(seat1, seat2) {
            const row1 = parseInt(seat1.match(/\d+/)[0]);
            const row2 = parseInt(seat2.match(/\d+/)[0]);
            const letter1 = seat1.match(/[A-Za-z]/) ? seat1.match(/[A-Za-z]/)[0] : '';
            const letter2 = seat2.match(/[A-Za-z]/) ? seat2.match(/[A-Za-z]/)[0] : '';
    
            if (row1 !== row2) return row1 - row2;
            return seatLetters.indexOf(letter1) - seatLetters.indexOf(letter2);
        }
    
        function addSeat() {
            openModal('seat-input-modal');
            updateSeatsGrid();
        }
    
        function updateSeatsGrid() {
            seatsGrid.innerHTML = '';
            
            const savedSeats = JSON.parse(localStorage.getItem('savedSeats')) || [];
            const endRow = parseInt(endSeat.match(/\d+/)[0]);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±—É–∫–≤—ã –º–µ—Å—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const letters = useLetters ? seatLetters : [''];
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫ —Ä–∞–≤–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –±—É–∫–≤
            seatsGrid.style.gridTemplateColumns = `repeat(${letters.length}, 1fr)`;
            
            // –°–æ–∑–¥–∞–µ–º —Ä—è–¥—ã –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö)
            for (let row = endRow; row >= startRow; row--) {
                letters.forEach(letter => {
                    const seatNumber = useLetters ? `${row}${letter}` : `${row}`;
                    if (!savedSeats.includes(seatNumber)) {
                        const seatElement = document.createElement('div');
                        seatElement.className = 'seat-option';
                        seatElement.textContent = seatNumber;
                        seatElement.dataset.seat = seatNumber;
                        if (useLetters) {
                            seatElement.dataset.letter = letter;
                        }
                        seatElement.onclick = function() {
                            this.classList.toggle('selected');
                        };
                        seatsGrid.appendChild(seatElement);
                    }
                });
            }
        }
    
        function confirmAddSelectedSeats() {
            const selectedSeatElements = document.querySelectorAll('.seat-option.selected');
            const savedSeats = JSON.parse(localStorage.getItem('savedSeats')) || [];
            
            if (selectedSeatElements.length === 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –º–µ—Å—Ç–æ!');
                return;
            }
            
            selectedSeatElements.forEach(seatElement => {
                let seatNumber = seatElement.dataset.seat;
                seatNumber = seatNumber.replace(/(\d+)([a-z])?/i, (_, num, letter) => 
                    num + (letter ? letter.toUpperCase() : '')
                );
                
                if (!savedSeats.includes(seatNumber)) {
                    savedSeats.push(seatNumber);
                    selectedSeats.push(seatNumber);
                    
                    const seatElement = document.createElement('div');
                    seatElement.className = 'seat selected-seat';
                    seatElement.setAttribute('data-seat', seatNumber);
                    seatElement.textContent = seatNumber;
                    rightColumn.appendChild(seatElement);
                }
            });
            
            localStorage.setItem('savedSeats', JSON.stringify(savedSeats));
            localStorage.setItem('selectedSeats', JSON.stringify(selectedSeats));
            closeSeatInputModal();
        }
    
        function closeSeatInputModal() {
            closeModal('seat-input-modal');
            document.querySelectorAll('.seat-option.selected').forEach(el => {
                el.classList.remove('selected');
            });
        }
    
        function openSettingsModal() {
            seatLettersInput.value = seatLetters.join(',');
            startRowInput.value = startRow;
            endSeatInput.value = endSeat;
            useLettersCheckbox.checked = useLetters;
            seatLettersInput.disabled = !useLetters;
            openModal('settings-modal');

            seatLettersInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase().replace(/[^A-Z,]/g, '');
            });
            
            endSeatInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            });
        }
    
        function closeSettingsModal() {
            closeModal('settings-modal');
        }
    
        function applySettings() {
            const letters = seatLettersInput.value.split(',')
                .map(l => l.trim().toUpperCase())
                .filter(l => l.length === 1 && /^[A-Z]$/.test(l));
            
            const row = parseInt(startRowInput.value);
            const end = endSeatInput.value.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
            const newUseLetters = useLettersCheckbox.checked;

            if ((newUseLetters && letters.length > 0 && !isNaN(row) && end) || 
                (!newUseLetters && !isNaN(row) && end)) {  // –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∞—è —Å–∫–æ–±–∫–∞
                
                const settingsChanged = 
                    JSON.stringify(letters) !== JSON.stringify(seatLetters) ||
                    row !== startRow ||
                    end !== endSeat ||
                    newUseLetters !== useLetters;

                if (settingsChanged) {
                    if (confirm('–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —Å–±—Ä–æ—Å—É –≤—Å–µ—Ö –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                        const savedSeats = JSON.parse(localStorage.getItem('savedSeats')) || [];
                        savedSeats.forEach(seat => {
                            localStorage.removeItem(`menu_${seat}`);
                        });
                        localStorage.removeItem('savedSeats');
                        localStorage.removeItem('selectedSeats');

                        seatLetters = newUseLetters ? letters : [];
                        startRow = row;
                        endSeat = end;
                        useLetters = newUseLetters;
                        selectedSeats = [];

                        leftColumn.innerHTML = '';
                        rightColumn.innerHTML = '';
                    }
                }

                closeSettingsModal();
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ! –ë—É–∫–≤—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç A –¥–æ Z.');
            }
        }    
        
        async function openFlightModal() {
            openModal('flight-modal');
            flightDirectionSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</option>';
    
            const url = 'https://raw.githubusercontent.com/saySPB/myFlightmenu/main/–õ–∏—Å—Ç%20Microsoft%20Excel.xlsx';
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
    
                const directions = [...new Set(jsonData.map(row => row['Flight Direction']))];
                directions.forEach(direction => {
                    flightDirectionSelect.innerHTML += `<option value="${direction}">${direction}</option>`;
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ä–µ–π—Å–æ–≤:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–µ–π—Å–æ–≤ —Å GitHub. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
            }
        }
    
        function closeFlightModal() {
            closeModal('flight-modal');
        }
    
        async function loadMenuFromGitHub() {
            const direction = flightDirectionSelect.value;
            if (!direction) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ!');
                return;
            }
    
            const url = 'https://raw.githubusercontent.com/saySPB/myFlightmenu/main/–õ–∏—Å—Ç%20Microsoft%20Excel.xlsx';
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
    
                const filteredData = jsonData.filter(row => row['Flight Direction'] === direction);
                const menuData = {};
                const cycles = [...new Set(filteredData.map(row => row['Cycle']))];
    
                cycles.forEach(cycle => {
                    menuData[cycle] = { sections: {}, subitems: {} };
                    const cycleData = filteredData.filter(row => row['Cycle'] === cycle);
                    cycleData.forEach(row => {
                        const section = row['Section'];
                        const item = row['Item'];
                        let subitems = [];
                        if (row['Subitem']) subitems.push(row['Subitem']);
                        if (row['Subitem.1']) subitems.push(row['Subitem.1']);
    
                        if (!menuData[cycle].sections[section]) {
                            menuData[cycle].sections[section] = [];
                        }
                        if (!menuData[cycle].sections[section].includes(item)) {
                            menuData[cycle].sections[section].push(item);
                        }
                        if (subitems.length > 0) {
                            menuData[cycle].subitems[item] = subitems;
                        }
                    });
                });
    
                localStorage.setItem('menuData', JSON.stringify(menuData));
                localStorage.setItem('flightDirection', direction);
                localStorage.setItem('cycles', JSON.stringify(cycles));
                alert('–ú–µ–Ω—é —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–≥—Ä—É–∂–µ–Ω–æ!');
                closeFlightModal();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é —Å GitHub. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
            }
        }
    
        leftColumn.addEventListener('click', handleSeatClick);
        rightColumn.addEventListener('click', handleSeatClick);
        useLettersCheckbox.addEventListener('change', () => {
            seatLettersInput.disabled = !useLettersCheckbox.checked;
        });
    
        function setupModalClose() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay').forEach(overlay => {
                        if (overlay.style.display === 'block') {
                            const modalId = overlay.id.replace('-overlay', '');
                            closeModal(modalId);
                        }
                    });
                }
            });
        }

        window.onload = function() {
            loadSeats();
            setupModalClose();
        };
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93d7fa27dbcf12e7',t:'MTc0Njg2NDgwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>